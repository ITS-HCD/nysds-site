<nav class="section-nav accordion" aria-label="Section Navigation" data-pagefind-ignore="all">
  <button
    id="accordion-trigger-{{ section | slug }}"
    class="section-nav__toggle accordion__trigger"
    type="button"
    aria-expanded="false"
    aria-controls="accordion-panel-{{ section | slug }}">
    <span class="accordion__label">{{ section }}</span>
    <nys-icon name="chevron_down" size="xl" aria-hidden="true"></nys-icon>
  </button>

  <ul
    class="section-nav__list accordion__panel"
    id="accordion-panel-{{ section | slug }}"
    aria-labelledby="accordion-trigger-{{ section | slug }}"
    hidden>


{% if section in collections.sections %}
  {% set top = collections.sections[section].topLevel %}
  {% set list = top %}

  {# If this section is the video series, sort by series_order #}
  {% if section | lower == "videos" %}
    {% set list = top | onlySeries | sortBySeriesOrder %}
  {% endif %}

  {# Loop through only top-level pages (kept identical) #}
  {% for page in list %}
    {% set isActive = (page.url == currentPageUrl) %}
    {% for child in page.children %}
      {% if child.url == currentPageUrl %}
        {% set isActive = true %}
      {% endif %}
    {% endfor %}
    <li class="section-nav__item{% if isActive %} section-nav__item--active-section{% endif %}{% if page.url == currentPageUrl %} section-nav__item--active{% endif %}"
        {% if page.children | length > 0 %} aria-expanded="{% if isActive %}true{% else %}false{% endif %}" {% endif %}>
      <a class="section-nav__link" href="{{ site.url | url }}{{ page.url }}" {% if page.url == currentPageUrl %} aria-current="page" {% endif %}>
        {{ page.data.title }}
      </a>

      {# Render child pages inside their parent (unchanged; videos typically have none) #}
      {% if page.children | length > 0 %}
        <ul class="section-nav__list" {% if not isActive %} hidden {% endif %}>
          {% for child in page.children %}
            <li class="section-nav__item{% if child.url == currentPageUrl %} section-nav__item--active{% endif %}">
              <a class="section-nav__link" href="{{ site.url | url }}{{ child.url }}" {% if child.url == currentPageUrl %} aria-current="page" {% endif %}>
                {{ child.data.title }}
              </a>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </li>
  {% endfor %}
{% endif %}

  </ul>
</nav>